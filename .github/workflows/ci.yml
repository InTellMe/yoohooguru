name: Continuous Integration

# Environment Variable Configuration Guidelines:
# 
# 1. Firebase Emulators:
#    - FIRESTORE_EMULATOR_HOST and FIREBASE_AUTH_EMULATOR_HOST should ONLY be set
#      when NODE_ENV=test or NODE_ENV=development
#    - NEVER set emulator variables when NODE_ENV=production or NODE_ENV=staging
#    - See docs/CI_CD_ENVIRONMENT.md for details
#
# 2. SESSION_SECRET:
#    - MUST be cryptographically secure (minimum 32 characters)
#    - Generate dynamically using: node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
#    - NEVER use hardcoded or default values in production/staging
#    - Use ::add-mask:: to prevent secret exposure in logs
#
# 3. API URLs:
#    - NEXT_PUBLIC_API_URL must be set for Next.js builds
#    - Use appropriate values per environment (development/staging/production)

permissions:
  contents: read
  pull-requests: write
  issues: write

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true    

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    outputs:
      artifact-errors-only: ${{ steps.check-artifacts.outputs.artifact-errors-only }}
      has-artifacts: ${{ steps.check-artifacts.outputs.has-artifacts }}
      orphan-analysis-status: ${{ steps.orphan-analysis.outcome }}
      orphan-reports-available: ${{ steps.orphan-analysis.outcome == 'success' || steps.orphan-analysis.outcome == 'failure' }}
    strategy:
      matrix:
        node-version: [20.19.5]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install root dependencies
        run: npm install --include=dev

      - name: Install main app dependencies
        run: cd apps/main && npm ci

      - name: Install backend dependencies
        run: cd backend && npm install

      - name: Verify TypeScript installation
        run: |
          if ! npm ls typescript > /dev/null 2>&1; then
            echo "âš ï¸ TypeScript missing - installing for CI"
            npm install --save-dev typescript @types/react @types/node
          fi
          npx tsc --version

      - name: Lint backend code
        run: cd backend && npm run lint
        continue-on-error: true

      - name: Generate secure SESSION_SECRET for tests
        id: generate-session-secret
        run: |
          # Generate a cryptographically secure session secret
          SESSION_SECRET=$(node -e "console.log(require('crypto').randomBytes(32).toString('hex'))")
          echo "::add-mask::$SESSION_SECRET"
          echo "session-secret=$SESSION_SECRET" >> $GITHUB_OUTPUT

      - name: Run backend tests
        run: |
          cd backend
          npm install -g firebase-tools
          npm test
        env:
          NODE_ENV: test
          FIREBASE_PROJECT_ID: yoohoo-dev-testing
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY_TEST }}
          # Use dynamically generated secure SESSION_SECRET
          SESSION_SECRET: ${{ steps.generate-session-secret.outputs.session-secret }}
          JWT_SECRET: test-jwt-secret-key-for-ci-cd-testing-only-not-for-production
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY_TEST }}
          STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY_TEST }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET_TEST }}
          STRIPE_WEBHOOK_ID: ${{ secrets.STRIPE_WEBHOOK_ID_TEST }}
          STRIPE_GURU_PASS_PRICE_ID: ${{ secrets.STRIPE_GURU_PASS_PRICE_ID_TEST }}
          STRIPE_SKILL_VERIFICATION_PRICE_ID: ${{ secrets.STRIPE_SKILL_VERIFICATION_PRICE_ID_TEST }}
          STRIPE_TRUST_SAFETY_PRICE_ID: ${{ secrets.STRIPE_TRUST_SAFETY_PRICE_ID_TEST }}
          # Firebase emulator variables (ONLY for test environment)
          # These MUST NOT be set when NODE_ENV is production or staging
          FIRESTORE_EMULATOR_HOST: localhost:8080
          FIREBASE_AUTH_EMULATOR_HOST: localhost:9099
        continue-on-error: true

      - name: Build main app with Turbo
        run: npx turbo run build --filter=@yoohooguru/main
        env:
          CI: true
          # Required for Next.js build - API endpoint URL
          NEXT_PUBLIC_API_URL: http://localhost:3001
          # NODE_ENV defaults to 'production' for next build, which is correct for CI builds

      - name: Analyze orphan modules
        id: orphan-analysis
        run: |
          chmod +x scripts/ci-orphan-detection.sh
          scripts/ci-orphan-detection.sh
        env:
          ORPHAN_ERROR_THRESHOLD: 10
        continue-on-error: true

      - name: Handle runtime log artifacts
        id: check-artifacts
        run: |
          chmod +x .github/scripts/handle-artifacts.sh
          .github/scripts/handle-artifacts.sh check

      - name: Upload runtime log artifacts (conditional)
        if: steps.check-artifacts.outputs.has-artifacts == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: runtime-logs
          path: |
            /home/runner/work/_temp/runtime-logs/blocked.jsonl
            /home/runner/work/_temp/runtime-logs/blocked.md
          retention-days: 30
          if-no-files-found: ignore
        continue-on-error: true

      - name: Upload orphan module reports
        uses: actions/upload-artifact@v4
        with:
          name: orphan-module-reports-${{ github.run_number }}
          path: |
            /home/runner/work/_temp/orphan-reports/
          retention-days: 90
          if-no-files-found: ignore
        continue-on-error: true

      - name: Post failure notification
        if: failure() && github.event.pull_request
        run: |
          # Post a quick notification - detailed logs will be posted by ci-failure-notifier workflow
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          COMMENT_BODY="@copilot âš ï¸ CI workflow failed. Detailed failure analysis is being generated and will be posted shortly. [View workflow run](${WORKFLOW_URL})"

          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -d "$(jq -n --arg body "$COMMENT_BODY" '{body: $body}')" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments"
        continue-on-error: true

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-and-test]
    if: github.ref == 'refs/heads/main' && github.actor != 'renovate[bot]'
    outputs:
      deployment-status: ${{ steps.deployment.outputs.status }}
      artifact-errors-only: ${{ steps.check-errors.outputs.artifact-errors-only }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Check for artifact-only errors
        id: check-errors
        run: |
          ARTIFACT_ERRORS_ONLY="false"
          if [ "${{ needs.build-and-test.outputs.artifact-errors-only || 'false' }}" == "true" ]; then
            ARTIFACT_ERRORS_ONLY="true"
            echo "âœ… Detected artifact-only error condition"
            echo "ðŸ“ This indicates a successful build with missing optional runtime logs"
          else
            echo "â„¹ï¸ No artifact-only error conditions detected"
          fi
          echo "artifact-errors-only=${ARTIFACT_ERRORS_ONLY}" >> $GITHUB_OUTPUT

      - name: Report deployment status
        id: deployment
        run: |
          echo "status=success" >> $GITHUB_OUTPUT
          echo "âœ… Deployment monitoring complete - using Vercel for production deployments"